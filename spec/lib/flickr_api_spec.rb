require 'spec_helper'
include FlickrApi

describe FlickrApi do

  before :each do
    @search_conditions = "cats"
    @page = 5

    @body = "<?xml version=\"1.0\" encoding=\"utf-8\" ?>\n<rsp stat=\"ok\">\n<photos page=\"5\" pages=\"39786\" perpage=\"50\" total=\"1989290\">\n\t<photo id=\"2725780198\" owner=\"91621746@N00\" secret=\"5ac7130de7\" server=\"3116\" farm=\"4\" title=\"IMG_5628\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"9085742138\" owner=\"93261850@N07\" secret=\"23ecc989f7\" server=\"7402\" farm=\"8\" title=\"Dino wat is dat nu op de foto!\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"9547000607\" owner=\"100563100@N08\" secret=\"2122881e21\" server=\"2817\" farm=\"3\" title=\"DSC05929\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"9494606708\" owner=\"9641560@N06\" secret=\"3962423021\" server=\"2830\" farm=\"3\" title=\"Willie\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"9475882990\" owner=\"9641560@N06\" secret=\"0af0bc745c\" server=\"2814\" farm=\"3\" title=\"Little One\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"9494676646\" owner=\"9641560@N06\" secret=\"7c56d71d34\" server=\"2854\" farm=\"3\" title=\"Hunter\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"9494823312\" owner=\"9641560@N06\" secret=\"de6752d04d\" server=\"7301\" farm=\"8\" title=\"Bianca\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"622975865\" owner=\"9099757@N05\" secret=\"5cb8ae38d7\" server=\"1420\" farm=\"2\" title=\"DSC01441\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"9540624354\" owner=\"7269902@N07\" secret=\"e3edd2c8ab\" server=\"7370\" farm=\"8\" title=\"Oldsters\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"191246961\" owner=\"87886161@N00\" secret=\"d0c874ffa9\" server=\"54\" farm=\"1\" title=\"munch\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"9566625352\" owner=\"58028998@N00\" secret=\"ddc205d289\" server=\"7333\" farm=\"8\" title=\"Cats Avoiding the Vacuum\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"3287529442\" owner=\"25968191@N07\" secret=\"d61286f952\" server=\"3184\" farm=\"4\" title=\"\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"9562907931\" owner=\"66728633@N00\" secret=\"55b6522b21\" server=\"7290\" farm=\"8\" title=\"nyc photo walk 324\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"7901010954\" owner=\"36522716@N06\" secret=\"4e0b31aaf4\" server=\"8322\" farm=\"9\" title=\"Have a break / I wish you all a wonderful weekend :)\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"9559732282\" owner=\"31496263@N00\" secret=\"087938e5a7\" server=\"5455\" farm=\"6\" title=\"Jiji\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"9560688350\" owner=\"31496263@N00\" secret=\"c4f173cafd\" server=\"7281\" farm=\"8\" title=\"Mimi\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"9356595231\" owner=\"62584399@N00\" secret=\"ce89b3fd3d\" server=\"7459\" farm=\"8\" title=\"Tiger - Panasonic DMC-G5 - LUMIX G VARIO 45-150/F4.0-5.6\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"141231628\" owner=\"42008558@N00\" secret=\"af51f651f1\" server=\"49\" farm=\"1\" title=\"Minka in Pflege\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"88728730\" owner=\"22298070@N00\" secret=\"65638f9500\" server=\"32\" farm=\"1\" title=\"Kitty Style - Leo mounts Piper\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"110856943\" owner=\"66205942@N00\" secret=\"3002e966d6\" server=\"38\" farm=\"1\" title=\"Bloebloe\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"9393579429\" owner=\"13437094@N02\" secret=\"1230633912\" server=\"3707\" farm=\"4\" title=\"sleepy J in the conservatory\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"67168952\" owner=\"86806049@N00\" secret=\"a913f7898b\" server=\"31\" farm=\"1\" title=\"Betty on the fence 2\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"3059419531\" owner=\"20814240@N00\" secret=\"ffca5912f4\" server=\"3141\" farm=\"4\" title=\"Turpin 255\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"5576116486\" owner=\"57398184@N00\" secret=\"4e7d5873ab\" server=\"5257\" farm=\"6\" title=\"IMG_5880\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"9568172160\" owner=\"94693506@N00\" secret=\"71832ca154\" server=\"2814\" farm=\"3\" title=\"lap of luxury\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"73354513\" owner=\"93978447@N00\" secret=\"97b4439750\" server=\"34\" farm=\"1\" title=\"Sunshine\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"8345306895\" owner=\"25076731@N05\" secret=\"6614cc978d\" server=\"8491\" farm=\"9\" title=\"White Persian Cat (\xE6\xB3\xA2\xE6\x96\xAF\xE8\xB2\x93)\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"8328715266\" owner=\"88754023@N03\" secret=\"6a0f4d2e87\" server=\"8081\" farm=\"9\" title=\"Supermac 1\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"2347770953\" owner=\"92367173@N00\" secret=\"54971d8739\" server=\"2266\" farm=\"3\" title=\"Bonnie &amp; Clyde\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"9568747884\" owner=\"66728633@N00\" secret=\"0eef75bd38\" server=\"2847\" farm=\"3\" title=\"SPORT 082\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"8731411895\" owner=\"77583847@N00\" secret=\"376a5a7505\" server=\"7053\" farm=\"8\" title=\"Cats of Morocco - Moulay Idriss\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"9564637736\" owner=\"38490773@N03\" secret=\"5fe58df0fe\" server=\"7352\" farm=\"8\" title=\"Excellent cats in Sarajevo\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"9481533884\" owner=\"96410013@N08\" secret=\"7497b811a8\" server=\"3805\" farm=\"4\" title=\"IMG_9017\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"5357317554\" owner=\"27718315@N02\" secret=\"f7b113c5d4\" server=\"5202\" farm=\"6\" title=\"Bhaji, December 1991\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"2882855244\" owner=\"30737449@N04\" secret=\"8c27535d8d\" server=\"3012\" farm=\"4\" title=\"i leave it to you\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"5480176059\" owner=\"36386822@N07\" secret=\"37356c10e0\" server=\"5258\" farm=\"6\" title=\"Fiona shakes her head\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"9567719377\" owner=\"93782583@N02\" secret=\"50ee654bd1\" server=\"5541\" farm=\"6\" title=\"\xE2\x80\x9EPenkta koja\xE2\x80\x9C: dovanojamas gyv\xC5\xABnas\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"8333243681\" owner=\"91759331@N04\" secret=\"4b54744fb2\" server=\"8364\" farm=\"9\" title=\"Swallowed a cat!\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"6324310262\" owner=\"69573851@N06\" secret=\"b6d3363738\" server=\"6114\" farm=\"7\" title=\"sky paradise #3\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"6828810902\" owner=\"69573851@N06\" secret=\"4066e2be9f\" server=\"7182\" farm=\"8\" title=\"safari\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"6992759935\" owner=\"69573851@N06\" secret=\"7032dda837\" server=\"7206\" farm=\"8\" title=\"Isafari\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"6996886149\" owner=\"69573851@N06\" secret=\"09026ce239\" server=\"6216\" farm=\"7\" title=\"safari\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"9573648486\" owner=\"66338926@N07\" secret=\"80d4dd2ea5\" server=\"7334\" farm=\"8\" title=\"Tabby's Place cats\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"6961868298\" owner=\"69573851@N06\" secret=\"2ccb3ae0a9\" server=\"8156\" farm=\"9\" title=\"safari\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"6961866410\" owner=\"69573851@N06\" secret=\"06a371d901\" server=\"8147\" farm=\"9\" title=\"safari\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"7118835031\" owner=\"69573851@N06\" secret=\"99fd62bd89\" server=\"8141\" farm=\"9\" title=\"safari\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"7007189726\" owner=\"69573851@N06\" secret=\"8a999cd424\" server=\"7116\" farm=\"8\" title=\"CAMEL SMILE\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"7617796496\" owner=\"69573851@N06\" secret=\"8cf08ec174\" server=\"8285\" farm=\"9\" title=\"camel smile\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"8128342167\" owner=\"69573851@N06\" secret=\"05ac88f595\" server=\"8191\" farm=\"9\" title=\"SAFARI #2\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n\t<photo id=\"8128269361\" owner=\"69573851@N06\" secret=\"78a0bf3af0\" server=\"8331\" farm=\"9\" title=\"SAFARI #2\" ispublic=\"1\" isfriend=\"0\" isfamily=\"0\" />\n</photos>\n</rsp>\n"

    @resulting_image_urls = ["http://farm4.static.flickr.com/3116/2725780198_5ac7130de7.jpg", "http://farm8.static.flickr.com/7402/9085742138_23ecc989f7.jpg", "http://farm3.static.flickr.com/2817/9547000607_2122881e21.jpg", "http://farm3.static.flickr.com/2830/9494606708_3962423021.jpg", "http://farm3.static.flickr.com/2814/9475882990_0af0bc745c.jpg", "http://farm3.static.flickr.com/2854/9494676646_7c56d71d34.jpg", "http://farm8.static.flickr.com/7301/9494823312_de6752d04d.jpg", "http://farm2.static.flickr.com/1420/622975865_5cb8ae38d7.jpg", "http://farm8.static.flickr.com/7370/9540624354_e3edd2c8ab.jpg", "http://farm1.static.flickr.com/54/191246961_d0c874ffa9.jpg", "http://farm8.static.flickr.com/7333/9566625352_ddc205d289.jpg", "http://farm4.static.flickr.com/3184/3287529442_d61286f952.jpg", "http://farm8.static.flickr.com/7290/9562907931_55b6522b21.jpg", "http://farm9.static.flickr.com/8322/7901010954_4e0b31aaf4.jpg", "http://farm6.static.flickr.com/5455/9559732282_087938e5a7.jpg", "http://farm8.static.flickr.com/7281/9560688350_c4f173cafd.jpg", "http://farm8.static.flickr.com/7459/9356595231_ce89b3fd3d.jpg", "http://farm1.static.flickr.com/49/141231628_af51f651f1.jpg", "http://farm1.static.flickr.com/32/88728730_65638f9500.jpg", "http://farm1.static.flickr.com/38/110856943_3002e966d6.jpg", "http://farm4.static.flickr.com/3707/9393579429_1230633912.jpg", "http://farm1.static.flickr.com/31/67168952_a913f7898b.jpg", "http://farm4.static.flickr.com/3141/3059419531_ffca5912f4.jpg", "http://farm6.static.flickr.com/5257/5576116486_4e7d5873ab.jpg", "http://farm3.static.flickr.com/2814/9568172160_71832ca154.jpg", "http://farm1.static.flickr.com/34/73354513_97b4439750.jpg", "http://farm9.static.flickr.com/8491/8345306895_6614cc978d.jpg", "http://farm9.static.flickr.com/8081/8328715266_6a0f4d2e87.jpg", "http://farm3.static.flickr.com/2266/2347770953_54971d8739.jpg", "http://farm3.static.flickr.com/2847/9568747884_0eef75bd38.jpg", "http://farm8.static.flickr.com/7053/8731411895_376a5a7505.jpg", "http://farm8.static.flickr.com/7352/9564637736_5fe58df0fe.jpg", "http://farm4.static.flickr.com/3805/9481533884_7497b811a8.jpg", "http://farm6.static.flickr.com/5202/5357317554_f7b113c5d4.jpg", "http://farm4.static.flickr.com/3012/2882855244_8c27535d8d.jpg", "http://farm6.static.flickr.com/5258/5480176059_37356c10e0.jpg", "http://farm6.static.flickr.com/5541/9567719377_50ee654bd1.jpg", "http://farm9.static.flickr.com/8364/8333243681_4b54744fb2.jpg", "http://farm7.static.flickr.com/6114/6324310262_b6d3363738.jpg", "http://farm8.static.flickr.com/7182/6828810902_4066e2be9f.jpg", "http://farm8.static.flickr.com/7206/6992759935_7032dda837.jpg", "http://farm7.static.flickr.com/6216/6996886149_09026ce239.jpg", "http://farm8.static.flickr.com/7334/9573648486_80d4dd2ea5.jpg", "http://farm9.static.flickr.com/8156/6961868298_2ccb3ae0a9.jpg", "http://farm9.static.flickr.com/8147/6961866410_06a371d901.jpg", "http://farm9.static.flickr.com/8141/7118835031_99fd62bd89.jpg", "http://farm8.static.flickr.com/7116/7007189726_8a999cd424.jpg", "http://farm9.static.flickr.com/8285/7617796496_8cf08ec174.jpg", "http://farm9.static.flickr.com/8191/8128342167_05ac88f595.jpg", "http://farm9.static.flickr.com/8331/8128269361_78a0bf3af0.jpg"]

    @number_of_pages_of_cats =  "39786"
    @current_page_of_cats = "5"

    stub_http_request(:post, "http://api.flickr.com/services/rest/").
    with(:body => {params: {"api_key"=>"ac32760a7c068fdcbc4cd21d96b28789", "per_page"=>"50", "sort"=>"relevance", "media"=>"photos", "tags"=>"cats", "page"=>"5"}},
                  :headers => {'Accept'=>'*/*; q=0.5, application/xml', 'Accept-Encoding'=>'gzip, deflate', 'Content-Length'=>'145', 'Content-Type'=>'application/x-www-form-urlencoded', 'User-Agent'=>'Ruby'}).
    to_return(:status => [200], body: @body, :headers => {})
  end

  describe "search" do
    describe "build_http_request" do
      it "should build and return the uri, http, and request objects" do
        @uri, @http, @request = FlickrApi.build_http_request(@search_conditions, @page)
        @uri.to_s.should eq("http://api.flickr.com/services/rest/")
        @http.inspect.should eq("#<Net::HTTP api.flickr.com:80 open=false>")
        @request.inspect.should eq("#<Net::HTTP::Get GET>")
      end
    end

    describe "make_http_request_and_return_body" do
      it "should make the http request and return the reponse body" do
        uri = URI.parse( "http://api.flickr.com/services/rest/" )
        params = {api_key: 'ac32760a7c068fdcbc4cd21d96b28789', per_page: 50, sort: 'relevance', media: 'photos', tags: @search_conditions, page: @page}
        xml_data = RestClient.post(uri.to_s, params: params)
        xml_data.should eq(@body)
      end
    end

    describe "parse_xml_and_return_objects" do
      it "should parse the repsonse body XML and return an array of image URLs, total number of pages, and current page number" do
        image_urls, number_of_pages, current_page = FlickrApi.parse_xml_and_return_objects(@body)
        image_urls.should eq(@resulting_image_urls)
        number_of_pages.should eq(@number_of_pages_of_cats)
        current_page.should eq(@current_page_of_cats)
      end
    end
  end

end
